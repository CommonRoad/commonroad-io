image: python

stages:
- style_check
- test
- deploy

before_script:
- curl -O https://bootstrap.pypa.io/get-pip.py
- python get-pip.py

style_checks:
  stage: style_check
  script:
    - pip install pycodestyle
    - git  diff ${CI_COMMIT_BEFORE_SHA}...${CI_COMMIT_SHA} -- '*.py' | pycodestyle --max-line-length=120 --diff
  allow_failure: True

build_and_test:
  image: python:3.6
  stage: test
  script:
    - pip install tox coverage
    - pip install -r ./requirements.txt
    - pip install -e .[tests]
    - coverage run commonroad/tests/run_tests.py
    - coverage report -m || true

push_to_internal_pipy_registry:
  # push the development version to the internal pipy registry https://gitlab.lrz.de/cps/commonroad-io/-/packages
  # before manually triggering the job, delete the previous package in case the version number didn't change
  stage: deploy
  when: manual
  only:
    - develop
  script:
    - pip install twine
    - python setup.py sdist bdist_wheel
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --skip-existing --repository-url https://gitlab.lrz.de/api/v4/projects/${CI_PROJECT_ID}/packages/pypi dist/*

